<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voice Chatbot</title>
  <style>
    :root{ --blue:#1d4ed8; --blue-dark:#1e3a8a; }
    body{font-family:system-ui,Segoe UI,Arial;max-width:800px;margin:40px auto;padding:0 16px;line-height:1.7}
    h1{font-size:22px}
    button{
      padding:10px 16px;border:0;border-radius:10px;cursor:pointer;margin:6px 6px 12px 0;
      box-shadow:0 2px 6px rgba(0,0,0,.1); background:var(--blue); color:#fff; font-weight:600
    }
    button:hover{ background:var(--blue-dark) }
    button:disabled{ opacity:.6; cursor:not-allowed }
    #log{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:10px;padding:12px}
    .box{background:#f0f5ff;border:1px solid #e0e7ff;border-radius:10px;padding:12px}
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ Voice Chatbot (faster-whisper + Cohere + gTTS)</h1>
  <p class="box">Ø§Ø¶ØºØ· <b>Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</b> ÙˆØªØ­Ø¯Ù‘Ø«ØŒ Ø«Ù… <b>Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø±Ø³Ø§Ù„</b>. Ø³ÙŠÙØ¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙˆÙŠÙØ´ØºÙ‘ÙÙ„ ØµÙˆØª Ø§Ù„Ø±Ø¯.</p>

  <div>
    <button id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø±Ø³Ø§Ù„</button>
  </div>

  <h3>Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØ±ÙˆØº:</h3>
  <div id="userText"></div>

  <h3>Ø±Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯:</h3>
  <div id="assistantText"></div>

  <h3>Ø§Ù„ØµÙˆØª:</h3>
  <audio id="player" controls></audio>

  <h3>Ø§Ù„Ø³Ø¬Ù„:</h3>
  <div id="log"></div>

<script>
(() => {
  const API_URL = "http://127.0.0.1:8000/voice-chat";

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const player   = document.getElementById('player');
  const userText = document.getElementById('userText');
  const asText   = document.getElementById('assistantText');
  const logBox   = document.getElementById('log');

  let mediaRecorder, chunks = [];
  function log(s){ logBox.textContent += s + "\n"; }

  async function startRecording(){
    chunks = [];
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus' : 'audio/webm';
    mediaRecorder = new MediaRecorder(stream, { mimeType: mime });
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
    mediaRecorder.onstop = sendAudio;
    mediaRecorder.start();
    startBtn.disabled = true; stopBtn.disabled = false;
    log("ğŸ”´ Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦");
  }

  async function stopRecording(){
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      startBtn.disabled = false; stopBtn.disabled = true;
      log("â¹ï¸ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù. Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦");
    }
  }

  async function sendAudio(){
    try {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const form = new FormData();
      form.append('audio', blob, 'input.webm');

      const res = await fetch(API_URL, { method: 'POST', body: form });
      if(!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      userText.textContent = data.transcript || '';
      asText.textContent   = data.reply_text || '';
      player.src = 'data:audio/mp3;base64,' + data.reply_audio_b64;
      player.play().catch(()=>{});
      log("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªØ´ØºÙŠÙ„.");
    } catch (err) {
      console.error(err);
      log("âŒ Ø®Ø·Ø£: " + err.message);
    }
  }

  startBtn.onclick = startRecording;
  stopBtn.onclick  = stopRecording;
})();
</script>
</body>
</html>
